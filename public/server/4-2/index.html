<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.16" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    
    <title>4-2 Events</title>
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/server/4-2/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://www.ipm.edu.mo/">
<b>COMP312 Internet Programming II</b>
</a>

      
    </div>
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
      
      

      <li class="dd-item  " data-nav-id="/basic/">
        <a href="/basic/">
          <span>
            
              <b>2. </b>
            
             JavaScript basics
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-1/">
              <a href="/basic/2-1/">
                <span>2-1 Basic data types and control     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-2/">
              <a href="/basic/2-2/">
                <span>2-2 Arrays and functions     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-3/">
              <a href="/basic/2-3/">
                <span>2-3 Objects and JSON data     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-4/">
              <a href="/basic/2-4/">
                <span>2-4 Callbacks and arrow functions     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-5/">
              <a href="/basic/2-5/">
                <span>2-5 Defining class     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/basic/2-6/">
              <a href="/basic/2-6/">
                <span>2-6 Reg expression     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      
      

      <li class="dd-item  " data-nav-id="/client/">
        <a href="/client/">
          <span>
            
              <b>3. </b>
            
             Client-side programming
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/client/3-1/">
              <a href="/client/3-1/">
                <span>3-1 Quick start     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-2/">
              <a href="/client/3-2/">
                <span>3-2 Select and change     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-3/">
              <a href="/client/3-3/">
                <span>3-3 Creating new content     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-4/">
              <a href="/client/3-4/">
                <span>3-4 Handling events     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-5/">
              <a href="/client/3-5/">
                <span>3-5 Form controls     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-6/">
              <a href="/client/3-6/">
                <span>3-6 Template     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-7/">
              <a href="/client/3-7/">
                <span>3-7 Charts     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/client/3-8/">
              <a href="/client/3-8/">
                <span>3-8 Page load and others     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      
      

      <li class="dd-item  parent" data-nav-id="/server/">
        <a href="/server/">
          <span>
            
              <b>4. </b>
            
             Server-side programming
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/server/4-1/">
              <a href="/server/4-1/">
                <span>4-1 Node.js primer     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item active" data-nav-id="/server/4-2/">
              <a href="/server/4-2/">
                <span>4-2 Events     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/server/4-3/">
              <a href="/server/4-3/">
                <span>4-3 Web client     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/server/4-4/">
              <a href="/server/4-4/">
                <span>4-4 Routing in web app     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/server/4-5/">
              <a href="/server/4-5/">
                <span>4-5 Middleware in web app     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/server/4-6/">
              <a href="/server/4-6/">
                <span>4-6 Template in web app     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/server/4-7/">
              <a href="/server/4-7/">
                <span>4-7 Database access     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
      
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                
                
                  
                
                  
                
                  
                    
                    
                <a href="/server/" itemprop="url"><span itemprop="title">Server-side programming</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                <span itemprop="title"> 4-2 Events</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#once-off-anonymous-events">Once-off anonymous events</a></li>
<li><a href="#timer-events">Timer events</a></li>
<li><a href="#event-emitters">Event emitters</a></li>
<li><a href="#installing-modules">Installing modules</a></li>
<li><a href="#exercise">Exercise</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
    	        <div id="body-inner">
                
                <h1>4-2 Events</h1>
                



<p>This lab goes through events and event emitters in Node.js.</p>

<h2 id="once-off-anonymous-events">Once-off anonymous events</h2>

<p>In Node, many asynchronous I/O operations has a callback parameter. These operations generate an once-off event when the I/O completes (with data or error). The event is appended to the event queue and the event loop periodically extracts the event in the front of queue and executes the registered event handler (the callback).</p>

<p>You can register 1 and only 1 callback for these once-off events.</p>

<p>Usually, the first parameter of the callback is an error object. Since the callback is run by the event loop (and not by any other functions), throwing an error inside the callback will quit the process.</p>

<pre><code class="language-JavaScript">fs.readFile('in.txt', 'utf8', (error, data) =&gt; {
  if (error) throw error;
  // no error, can process the result data of the I/O operation
  // ...
})
</code></pre>

<h2 id="timer-events">Timer events</h2>

<p>JavaScript timers <code>setTimeout()</code> and <code>setInterval()</code> also trigger anonymous events. <code>setTimeout()</code> generates an once-off event. On the other hand, <code>setInterval()</code> generates events repeatedly until you clear the timer by <code>clearInterval()</code>.  The Node process does not quit when there is an active timer that may trigger events in the future. (Advanced: <code>timer.unref()</code> affects this.)</p>

<pre><code class="language-JavaScript">var n = 1;
var timer = setInterval(
  ()=&gt;{
    console.log(`tick ${n++}`);
  },
  1000
);
</code></pre>

<h2 id="event-emitters">Event emitters</h2>

<p>Objects that inherit from the class <code>EventEmitter</code> <a href="https://nodejs.org/dist/latest-v6.x/docs/api/events.html">(online reference)</a> can also trigger events. An event emitter is similar to DOM node in browsers.</p>

<ul>
<li>an object may generate several kinds of events, each identified with a name, e.g. &lsquo;data&rsquo;, &lsquo;error&rsquo;</li>
<li>you can register a event handler with <code>obj.on(event, callback)</code></li>
<li>you can register more than 1 event handler for an event. When the object triggers the event, the event loop will runs the event handler one by one.</li>
</ul>

<p>A common example of event emitters is a basic HTTP server written in Node. (See code below)
When the http server receives an HTTP request from web browsers, it triggers an event <code>request</code>.</p>

<pre><code class="language-JavaScript">// p201.js
var http = require('http');
var server = http.createServer();

server.on('request', (req, resp) =&gt; {
  console.log(`request: url=${req.url}`);
  resp.writeHead(200, {'Content-Type': 'text/plain'});
  resp.write('Hello World \n');
  // you can resp.write() more ...
  resp.end();
});

server.listen(3000, () =&gt; {
  console.log('Server running at http://localhost:3000/');
});
</code></pre>

<h2 id="installing-modules">Installing modules</h2>

<p>Next, we use an external module to demonstrate more features of EventEmitter.</p>

<p>Suppose we have a large text file that we want to process line by line. We don&rsquo;t want to read the text file completely into memory buffer using a call to <code>fs.readFile()</code>.  The built-in object <code>ReadableStream</code> returned by <code>fs.createReadStream</code> can stream the file content, but we still need to detect line breaks. Fortunately, the Node.js community has ready-to-use solution for this problem, published as <strong>modules</strong> in <a href="https://www.npmjs.com/">https://www.npmjs.com/</a>.  For example, you can use the module <a href="https://www.npmjs.com/package/linereader">linereader</a> to easily read a text file line-by-line.</p>

<p>Before using the module, install it in command line with <code>npm install</code>. Put your JavaScript program in a folder, and while in that folder, run the command <code>npm install linereader</code>.  You&rsquo;ll see that the command <code>npm</code> installs the module in a local folder called <code>node_modules</code>.</p>

<p>After installation, you can use the module with <code>require('linereader')</code>.  The source code of p201.js is listed below. The module exports a <code>class</code>, which provides a constructor to create an object that reads a given file line-by-line.</p>

<pre><code class="language-JavaScript">// p203.js
// read a text file line by line
var LineReader = require('linereader');

var lr = new LineReader('./intro.txt');

lr.on('error', (err) =&gt; {
  console.log(err);
  lr.close();
});

lr.on('line', (lineno, line) =&gt; {
  console.log(`${lineno}  ${line}`);
});

lr.on('end', () =&gt; {
  console.log(&quot;== end ==&quot;);
});
</code></pre>

<p>The object is an <code>EventEmitter</code>. It generates three kinds of events.  For each line read, it generates a <code>line</code> event. The event handler for this event has two parameters: line number, and the line content. At file end, the object generates the <code>end</code> event.</p>

<p>The last kind of events generated by the line reader object is <code>error</code>.
This special event reports error and demonstrates an important difference between event emitters and once-off events. The object triggers the <code>error</code> event when its operation hits an error. If there is no event handler registered for <code>error</code>, the object will throw an exception and the Node process quits.</p>

<p>Now, try to generate an <code>error</code> event by changing the file name to an non-existing file.</p>

<h2 id="exercise">Exercise</h2>

<p>TODO TODO</p>


      
      </div>
    </div>

    <div id="navigation">
        
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/jquery-2.x.min.js"></script>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky-kit.min.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>
    

  </body>
</html>

