<!DOCTYPE html>
<html>
<head>  
  <title>Asynchronous GET/POST requests with JSON</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; line-height: 1.4; }
    h1 { font-size: 1.5em; margin: 2px 2px; }
    h2 { font-size: 1.2em; border-bottom: solid 1px lightblue; }
    .step { font-style: italic; background-color: lightgreen; }
    code { color: darkblue; }
    
    #addform label { width: 100px; float: left; }
    #addform div { margin: 1em 0px; }
    #addform input[type='text'] { font-size: 1.2em; }

    table#todo { border-collapse: collapse; border: 1px solid gray; }
    table#todo td, table#todo th { border: 1px solid gray; padding: 4px 8px; }
    table#todo thead { border-bottom: 3px double gray; }  
    table#todo td.editing { background-color: rgba(255, 255, 100, 0.3); color: blue; }  

    .white-popup {
      position: relative;
      background: white; padding: 20px; margin: 20px auto;
      width: auto; max-width: 500px; 
    }
  </style>
  
  <script src="jquery-2.1.1.min.js"></script>

  <!-- Magnific Popup core JS file -->
  <link rel="stylesheet" href="magnific-popup/magnific-popup.css"> 
  <script src="magnific-popup/jquery.magnific-popup.js"></script> 
  <script>
  $(document).ready(function() {
    $('.popup-link').magnificPopup({type:'inline', showCloseBtn: true, enableEscapeKey: true});
  });
  </script>

  <script>    
  // Part 3. Add / Delete / Retrieve combined
    
  function addTodoAction() {
    var query = {
      due: $('#addform input[name=due]').val(),
      task: $('#addform input[name=task]').val(),
      category: $('#addform input[name=category]').val(),
      priority: $('#addform input[name=priority]').val()
    };
    $.post('/addTodo', query, function (data, textStatus, jqXHR) {
      //alert('Response status=' + jqXHR.status + ' ' + jqXHR.statusText);
      $.magnificPopup.close();
      refreshTable();
    });
  }
  
  function delTodoAction () {
    var query = { id: $(this).data('id_Todo') };
    //alert('To delete ' + query);
    $.post('/delTodo', query, function (data, textStatus, jqXHR) {
      //alert('Response status=' + jqXHR.status + ' ' + jqXHR.statusText);
      refreshTable();
    });
  }

  function updateTodoAction () {
    var query = { id: $(this).data('id_Todo') };
    var row = $(this).parent().parent();
    row.find('td').slice(0,4).attr('contenteditable', 'true').addClass('editing');
    row.find('td').eq(0).focus();

    var thisButton = $(this);
    setTimeout(function() {
      thisButton.unbind('click', updateTodoAction);
      thisButton.text('save').bind('click', saveUpdateTodoAction);
      // disable the 'delete' button
      thisButton.next().prop('disabled', true);
    }, 0);
  }

  function saveUpdateTodoAction () {
    var row = $(this).parent().parent();
    var thisButton = $(this);
    setTimeout(function() {
      thisButton.unbind('click', saveUpdateTodoAction);
      thisButton.text('update').bind('click', updateTodoAction);
      thisButton.next().prop('disabled', false);
    }, 0);
    row.find('td').slice(0,4).attr('contenteditable', 'false').removeClass('editing');

    var query = { id: $(this).data('id_Todo') };
    query.due = row.children().eq(0).text();
    query.task = row.children().eq(1).text();
    query.category = row.children().eq(2).text();    
    query.priority = row.children().eq(3).text();    
    $.post('/updateTodo', query, function (data, textStatus, jqXHR) {
      //alert('Response status=' + jqXHR.status + ' ' + jqXHR.statusText);
      refreshTable();
    });
  }
  
  function fillTodoTable (todoList) {
    var tbody = $('table#todo tbody');
    tbody.empty();
    for (var i=0; i<todoList.length; i++) {
      var row = '<tr><td>'+todoList[i].due+'</td>';
      row += '<td>'+todoList[i].task+'</td>';
      row += '<td>'+todoList[i].category+'</td>';
      row += '<td>'+todoList[i].priority+'</td>';
      row += '</tr>';
      var r = $(row);
      var aUpdate = $('<button type=button>edit</button>');
      aUpdate.data('id_Todo', todoList[i].id);
      aUpdate.click(updateTodoAction);
      var aDel = $('<button type=button>delete</button>');
      aDel.data('id_Todo', todoList[i].id);
      aDel.click(delTodoAction);
      $('<td>').append(aUpdate).append(aDel).appendTo(r);
      tbody.append(r);
    }
  }
  
  function refreshTable() {
    var query = { }; // { start: '2011-05-02', end: '2013-05-08' };
    $.get('/getTodo', query, function (data, textStatus, jqXHR) {
      fillTodoTable(data.data);
    }); 
  }
  
  $(document).ready( function () {
    refreshTable();
    $('#btn1').click( function () {
      addTodoAction(); 
    });
    $('#btn2').click( function () {
      refreshTable(); 
    });
  });
  
  </script>
</head>

<body>
  <h2>comp312-todo app, ajax version</h2>
  <p>This app combines several operations to one interface. This is an example
  of an Ajax user interface for tabular data management. Read the code to see
  the details.</p>
  

  <table id='todo'>
    <thead><th>Due</th><th>Task</th><th>Category</th><th>Priority</th><td></td></thead>
    <tbody>
    </tbody>
  </table>
  
  <p><button type='button' id='btn2'>Refresh</button></p>

  <a href='#add-popup' class='popup-link'>Add a new todo</a>

  <div id='add-popup' class="white-popup mfp-hide">
  <form id='addform' action=''>
    <div><label>Due:</label><input type='text' name='due' value='2014-05-25'></div>
    <div><label>Task:</label><input type='text' name='task' value='comp312 project'></div>
    <div><label>Category:</label><input type='text' name='category' value='study'></div>
    <div><label>Priority:</label><input type='text' name='priority' value='3'></div>
    <div><button type='button' id='btn1'>Add a todo</button></div>
  </form>  

  
</body>
</html>

